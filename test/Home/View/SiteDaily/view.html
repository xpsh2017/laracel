<extend name="Public:app" />
<block name="content">
    <div id="app">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">{$panelName}</h3>
            </div>
            <div class="panel-body query-form">
                <form class="form-inline" method="POST">
                    <input type="hidden" name="siteUUID" value="{$site}">
                    <input type="hidden" name="source" value="{$source}">
                    <div class="form-group">
                        <label for="title">Site</label>
                        <select name="siteName" id="" class="form-control" v-model="siteUUID">
                            <option v-for="site in siteList" :value="site.SITE_UUID">{{ site.SITE_NAME }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="title">Date Range</label>
                        <div class="input-daterange input-group datepicker">
                            <input type="text" class="form-control datepicker1" name="startTime" v-model="startDate">
                            <span class="input-group-addon">to</span>
                            <input type="text" class="form-control datepicker2" name="endTime" v-model="endDate">
                        </div>
                    </div>
                    <a href="javascript:;" :class="searchButton.class" @click="getList()">{{ searchButton.text}}</a>
                </form>
            </div>
            <table class="table table-striped table-bordered mytable">
                    <thead>
                        <tr>
                            <template v-if="source.indexOf('sample_requirement') == -1">
                                <th v-for="colunm in list.columns">{{ zn(colunm) }}</th>    
                            </template>
                            <template v-else>
                                <th>{{ zn('DATE') }}</th>
                                <th>{{ zn('Total_Page_Count') }}</th>
                                <th>{{ zn('NO_Requirement_Page_Count') }}</th>
                                <th>{{ zn('DA_BIAO_LV') }}</th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-if="source.indexOf('sample_requirement') == -1">
                            <tr v-for="data in list.list">
                                <td v-for="(cell, key, index) in data">
                                    <template v-if="key == 'AVG_POS'">
                                        {{ cell | posFilter}}
                                    </template>
                                    <template v-else-if="key == 'DATE'">
                                        {{ cell }}
                                    </template>
                                    <template v-else-if="key =='BOUNSE_RATE'">
                                        {{ cell | numToPer}}
                                    </template>
                                    <template v-else>
                                        {{ cell | toThousands}}
                                    </template>
                                </td>
                            </tr>    
                        </template>
                        <template v-else>
                            <tr v-for="data in list.list">
                                <td>{{ data.DATE }}</td>
                                <td>{{ data.Total_Page_Count }}</td>
                                <td>{{ data.NO_Requirement_Page_Count }}</td>
                                <td>{{ dailyPer(data.NO_Requirement_Page_Count, data.Total_Page_Count) }}</td>
                            </tr>    
                        </template>
                    </tbody>
                </table>
        </div>
    </div>
</block>
<block name="custome-css">
    <link rel="stylesheet" href="/node_modules/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css">
</block>
<block name="custome-js">
    <script src="/node_modules/vue/dist/vue.min.js"></script>
    <script src="/node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script>
        let defaultAjaxConfig = {
            dataType: 'json',
            type: 'POST',
            error: function(error){
                alert('failed !')
            }
        }
        let app = new Vue({
            el: '#app',
            created: function(){
                let that = this
                this.apiRoot = this.getApiRoot()
                this.getDefaultData()
            },
            mounted: function(){
                let that = this
                $('.datepicker1').datepicker({
                    format: 'yyyy-mm-dd',
                    autoclose: true
                }).on('changeDate', function(ev){
                    let tmpDate = new Date(ev.date)
                    let toYear = tmpDate.getFullYear().toString()
                    let toMonth = (tmpDate.getMonth() < 10 ? '0' : '') + (tmpDate.getMonth() +1)
                    let toDate = (tmpDate.getDate() < 10 ? '0' : '') + (tmpDate.getDate())
                    that.startDate = toYear + '-' + toMonth + '-' + toDate
                })
                $('.datepicker2').datepicker({
                    format: 'yyyy-mm-dd',
                    autoclose: true
                }).on('changeDate', function(ev){
                    let tmpDate = new Date(ev.date)
                    let toYear = tmpDate.getFullYear().toString()
                    let toMonth = (tmpDate.getMonth() < 10 ? '0' : '') + (tmpDate.getMonth() +1)
                    let toDate = (tmpDate.getDate() < 10 ? '0' : '') + (tmpDate.getDate())
                    that.endDate = toYear + '-' + toMonth + '-' + toDate
                })
            },
            data: {
                apiRoot: '',
                siteUUID: '',
                siteDate: '',
                siteList: [],
                startDate: '2017-09-01',
                endDate: '2017-09-08',
                source: '',
                list: {
                    columns: null,
                    list: null
                },
                searchButton: {
                    class: 'btn btn-info',
                    text: 'Update'
                },
                metricList: {
                    
                }
            },
            methods: {
                getApiRoot: function(){
                    let tmp = window.location.href.split('/')
                    tmp.pop()
                    return tmp.join('/')
                },
                getDefaultData: function(){
                    let that = this
                    // 获取默认站点，默认时间，站点列表
                    let ajaxConfig = {
                        url: that.apiRoot + '/getDefaultData',
                        success: function(data){
                            that.siteUUID = data.defaultSite.SITE_UUID
                            that.siteName = data.defaultSite.SITE_NAME
                            that.siteDate = data.defaultDate
                            that.siteList = data.siteList
                            that.metricList = data.metricList
                            that.$nextTick(function(){
                                that.siteUUID = $('input[name=siteUUID]').val()
                                that.source = $('input[name=source]').val()
                                that.getList()
                            })
                        }
                    }
                    $.extend(ajaxConfig, defaultAjaxConfig)
                    $.ajax(ajaxConfig)
                },
                getList: function(){
                    let that = this
                    let data = {
                        siteUUID: this.siteUUID,
                        source: this.source,
                        startDate: this.startDate,
                        endDate: this.endDate,
                    }
                    let ajaxConfig = {
                        url: that.apiRoot + '/getList',
                        data: data,
                        beforeSend: function(){
                            that.searchButton = {
                                text: 'Updating...',
                                class: 'btn btn-success'
                            }
                        },
                        success: function(data){
                            that.list = data
                            that.searchButton = {
                                text: 'Update',
                                class: 'btn btn-info'
                            }
                        }
                    }
                    $.extend(ajaxConfig, defaultAjaxConfig)
                    $.ajax(ajaxConfig)
                },
                zn: function(str){
                    if(this.metricList.hasOwnProperty(str))
                    {
                        return this.metricList[str]
                    }else{
                        return str
                    }
                  },
                dailyPer: function(metric, chushu){
                    if(chushu == undefined)
                        chushu = this.basicData.list.PAGE_COUNT
                    if(typeof metric !== 'number' && metric%1 !== 0)
                        return '-'
                    if(metric === undefined || metric == '')
                    {
                        return undefined
                    }else{
                        let num = (metric/chushu)*100
                        num =num.toFixed(2) + '%'
                        return num
                    }
                }
            },
            filters: {
                numToPer: function(floatNum){
                    if(floatNum === undefined)
                    {
                        return undefined
                    }
                    else {
                        let num = (Math.round(floatNum * 10000 )/ 100).toFixed(2) + '%'
                        return num
                    }
                },
                toThousands: function(num) {
                    if(num === undefined)
                        return undefined
                    num = (num || 0).toString(), result = ''
                    fnum = num.split('.')
                    num =fnum[0]
                    while (num.length > 3) {
                        result = ',' + num.slice(-3) + result
                        num = num.slice(0, num.length - 3)
                    }
                    if (num) { result = num + result}
                    if(typeof fnum[1] != 'undefined')
                    {
                        console.log(fnum[1])
                        result += '.'+fnum[1]
                    }
                    return result
                },
                posFilter: function(floatNum){
                    if(floatNum === undefined)
                    {
                        return undefined
                    }
                    else {
                        let num = (Math.round(floatNum * 10 )/ 10).toFixed(1)
                        return num
                    }  
                },
            }
        })
    </script>
</block>